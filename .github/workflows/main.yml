name: Build OpenWrt

on: workflow_dispatch

env:
  OPENWRT_URL: https://github.com/coolsnowwolf/lede.git
  OPENWRT_BRANCH: master
  TZ: UTC

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Setup environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/P3TERX/openwrt-list/master/depends-ubuntu-2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Clone OpenWrt and mknop
        run: |
          git clone --depth 1 -b "$OPENWRT_BRANCH" "$OPENWRT_URL" ./openwrt
          git clone --depth 1 https://github.com/tuanqing/mknop.git

      - name: Copy feeds.conf.default
        run: |
          [ -f ./feeds.conf.default ] && cp ./feeds.conf.default ./openwrt/

      - name: Update and install feeds
        run: cd ./openwrt/ && ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: Copy .config
        run: |
          [ -f ./.config ] && cp ./.config ./openwrt/

      - name: Run custom.sh
        run: |
          if [ -f ./custom.sh ]; then
            chmod +x ./custom.sh
            cd ./openwrt/
            "$GITHUB_WORKSPACE"/custom.sh
          fi

      - name: Make OpenWrt
        run: |
          cd ./openwrt/
          make defconfig
          make -j8 download
          make -j"$(nproc)" || make -j1 || make -j1 V=s

      - name: Build image
        run: |
          cp ./openwrt/bin/targets/*/*/*.tar.gz ./mknop/openwrt/
          cd ./mknop/
          sudo ./gen_openwrt -d -k latest -m phicomm-n1

      - name: Prepare for uploading artifact
        run: |
          cp ./openwrt/.config ./mknop/out/phicomm-n1/
          cd ./mknop/out/phicomm-n1/
          du -h ./* ./.config
          sha256sum ./* ./.config

      - name: Upload artifact
        uses: actions/upload-artifact@main
        with:
          name: openwrt-phicomm-n1
          path: ./mknop/out/phicomm-n1/
